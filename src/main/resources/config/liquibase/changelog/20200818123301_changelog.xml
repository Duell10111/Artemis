<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet author="sebastianjagla" id="20200815153600">
        <createTable tableName="student_scores">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="student_scoresPK"/>
            </column>
            <column name="student_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="exercise_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="result_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="score" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="sebastianjagla" id="20200815153601">
        <!-- fill the table with existing results -->
        <sql>
            insert into student_scores (student_id, exercise_id, result_id, score)
            select p.student_id, e.id, r.id, r.score
            from participation p, exercise e, result r
            where e.id = p.exercise_id and p.id = r.participation_id and r.rated = 1 and r.score is not null
        </sql>
    </changeSet>
</databaseChangeLog>
